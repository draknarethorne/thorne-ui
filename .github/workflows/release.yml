name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'    # Standard releases (e.g., v0.6.3)
      - 'v*.*.*-*'  # Pre-releases (e.g., v0.6.3-rc.1)
      - 'v*_*_*'    # Legacy underscore tags (e.g., v0_6_3)
      - 'v*_*_*-*'  # Legacy underscore pre-releases (e.g., v0_6_3-pre)

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation
      
      - name: Extract version from tag
        id: get_version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          VERSION=${VERSION//_/.}

          PRERELEASE=false
          if [[ "$TAG" == *"-"* || "$TAG" == *_pre* || "$TAG" == *_rc* || "$TAG" == *_beta* || "$TAG" == *_alpha* ]]; then
            PRERELEASE=true
          fi

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "PRERELEASE=$PRERELEASE" >> $GITHUB_OUTPUT
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            # First release - get all commits
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # Get commits since previous tag
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Save to file for multi-line handling
          echo "$COMMITS" > changelog.txt
      
      - name: Create UI package
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          
          # Create release directory
          mkdir -p releases
          
          # Package thorne_drak (primary release variant)
          if [ -d "thorne_drak" ]; then
            echo "Packaging thorne_drak..."
            zip -r "releases/thorne_drak-v${VERSION}.zip" "thorne_drak/" -x "*.git*" "*.md"
          fi
          
          # Create a complete package with thorne_drak and documentation
          echo "Creating complete package..."
          zip -r "releases/thorne-ui-v${VERSION}.zip" \
            .docs/ \
            thorne_drak/ \
            README.md \
            DEVELOPMENT.md \
            -x "*.git*" "*TODO.md"
      
      - name: Create Release Notes
        id: release_notes
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          
          # Create release notes
          cat > release_notes.md << 'EOF'
          # Thorne UI v$VERSION
          
          **A legendary UI for TAKP**—Draknare Thorne's masterwork where classic EverQuest aesthetics meet modern playability. Crafted for players who demand clarity, accessibility, and choice.
          
          ## Installation
          
          1. Download `thorne_drak-v$VERSION.zip`
          2. Extract the zip file to your TAKP installation directory: `<TAKP Install>/uifiles/`
          3. In-game, use the command: `/loadskin thorne_drak`
          4. The UI will automatically reload with the new skin
          
          ## What's Inside
          
          **Gameplay-focused design** built for 1920x1080 resolution and larger—every window optimized for visibility and quick access, without clutter.
          
          **Key Features:**
          - Always-visible player stats, health, and buffs (no window juggling)
          - Large 45x45px slot sizing for easier clicking and accuracy
          - Reorganized merchant and loot windows for faster trading and looting
          - Multi-tab designs for quick access to related information
          - Anatomical equipment layout for intuitive gear management
          - Extensive Options variants for different playstyles

          ## About This Project

          - **Origin**: Built on QQQuarm mod foundations  
          - **Inspiration**: Nillipuss UI (feature ideas and quality targets)  
          - **Community**: References and analysis from DuxaUI, Infiniti-Blue, QQ, vert, zeal, and default UI
          - **Craft**: All custom layouts, documentation, and textures by **Draknare Thorne**  
          
          ## What Changed in This Release
          
          EOF
          
          # Add changelog
          cat changelog.txt >> release_notes.md
          
          # Add footer
          cat >> release_notes.md << 'EOF'
          
          ## Learn More
          
          - [README.md](https://github.com/draknarethorne/thorne-ui/blob/main/README.md) - Features, installation, and documentation  
          - [STANDARDS.md](https://github.com/draknarethorne/thorne-ui/blob/main/.docs/STANDARDS.md) - UI development standards and patterns  
          - [DEVELOPMENT.md](https://github.com/draknarethorne/thorne-ui/blob/main/DEVELOPMENT.md) - Architecture, workflows, and technical details  
          - [Full Changelog](https://github.com/draknarethorne/thorne-ui/commits/main) - All commits on main branch
          
          ## Get Involved
          
          Found an issue? Have a feature idea? Want to contribute? Visit the [GitHub repository](https://github.com/draknarethorne/thorne-ui) and open an issue or pull request.
          
          ---
          
          **Maintainer**: Draknare Thorne  
          **License**: Custom UI for personal use with The Al'Kabor Project  
          **Repository**: [draknarethorne/thorne-ui](https://github.com/draknarethorne/thorne-ui)
          EOF
          
          # Replace $VERSION placeholder
          sed -i "s/\$VERSION/$VERSION/g" release_notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Thorne UI ${{ steps.get_version.outputs.TAG }}
          body_path: release_notes.md
          files: releases/*.zip
          draft: false
          prerelease: ${{ steps.get_version.outputs.PRERELEASE == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
